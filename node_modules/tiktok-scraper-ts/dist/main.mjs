var S=Object.defineProperty;var a=(s,o)=>S(s,"name",{value:o,configurable:!0});import{fileURLToPath as E}from"url";import R from"path";var V=a(()=>E(import.meta.url),"getFilename"),N=a(()=>R.dirname(V()),"getDirname"),d=N();import*as U from"cheerio";import C from"miniget";import x from"node-fetch";import{createWriteStream as y,existsSync as T,mkdirSync as W,unlinkSync as _}from"node:fs";import O from"node:http";import D from"node:https";import{exit as q}from"node:process";var I=class{constructor(o,i,n,e,t,u,r,h,c,p,w,v,b,M,k){this.id=o,this.uniqueId=i,this.nickname=n,this.avatar=e,this.signature=t,this.createdAt=u,this.verified=r,this.secretUID=h,this.bioLink=c,this.privateAccount=p,this.isUnderAge18=w,this.followers=v,this.following=b,this.hearts=M,this.videos=k}};a(I,"User");var A=class{constructor(o,i,n,e,t,u,r,h,c,p){this.author=o,this.video=i,this.audio=n,this.shareCount=e,this.likesCount=t,this.commentCount=u,this.playCount=r,this.createdAt=h,this.tiktokLink=c,this.thumbnail=p}};a(A,"TikTokResult");var g=class{constructor(o,i,n,e,t,u,r,h,c,p,w,v,b,M,k,$,L){this.id=o,this.description=i,this.createdAt=n,this.height=e,this.width=t,this.duration=u,this.resolution=r,this.shareCount=h,this.likesCount=c,this.commentCount=p,this.playCount=w,this.downloadURL=v,this.cover=b,this.dynamicCover=M,this.playURL=k,this.format=$,this.author=L}};a(g,"Video");var f=class{constructor(o,i,n,e,t,u,r,h,c){this.id=o,this.title=i,this.playURL=n,this.coverLarge=e,this.coverThumb=t,this.author=u,this.duration=r,this.original=h,this.album=c}};a(f,"Music");var l=class{async requestWebsite(o,i){let n=new O.Agent({keepAlive:!0,maxSockets:20}),e=new D.Agent({keepAlive:!0,maxSockets:20}),t={agent:c=>c.protocol=="http:"?n:e,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36 Edg/97.0.1072.62"}},r=await(await x(`${o}`,i||t)).text();return U.load(r,{xmlMode:!0})}handleHTMLContent(o){let i=o,n=i.split("window['SIGI_STATE']=")[1].indexOf(";window['SIGI_RETRY']=");return JSON.parse(i.split("window['SIGI_STATE']=")[1].slice(0,n))}async video(o){if(!o)throw new Error("A video URL must be provided");let n=(await this.requestWebsite(o))("#SIGI_STATE").text(),e=JSON.parse(n),t=e.ItemList.video.list[0];return new g(e.ItemModule[t].video.id,e.ItemModule[t].desc,new Date(Number(e.ItemModule[t].createTime)*1e3).toLocaleDateString(),Number(e.ItemModule[t].video.height),Number(e.ItemModule[t].video.width),Number(e.ItemModule[t].video.duration),e.ItemModule[t].video.ratio,e.ItemModule[t].stats.shareCount,e.ItemModule[t].stats.diggCount,e.ItemModule[t].stats.commentCount,e.ItemModule[t].stats.playCount,e.ItemModule[t].video.downloadAddr.trim(),e.ItemModule[t].video.cover,e.ItemModule[t].video.dynamicCover,e.ItemModule[t].video.playAddr.trim(),e.ItemModule[t].video.format,e.ItemModule[t].nickname)}async user(o){if(!o)throw new Error("Please enter a username");let n=(await this.requestWebsite(`https://www.tiktok.com/@${o}`))("#SIGI_STATE").text(),e=JSON.parse(n),t=e.UserModule.users[o];return new I(t.id,t.uniqueId,t.nickname,t.avatarLarger,t.signature.trim(),new Date(t.createTime*1e3).toLocaleDateString(),t.verified,t.secUid,t?.bioLink?.link,t.privateAccount,t.isUnderAge18,e.UserModule.stats[o].followerCount,e.UserModule.stats[o].followingCount,e.UserModule.stats[o].heart,e.UserModule.stats[o].videoCount)}async getAllVideosFromUser(o){if(!o)throw new Error("You must provide a username!");let n=(await this.requestWebsite(`https://www.tiktok.com/@${o}`))("#SIGI_STATE").text(),e=JSON.parse(n),t=[],{ItemList:u}=e;return u["user-post"].list.forEach(r=>{t.push(new g(e.ItemModule[r].video.id,e.ItemModule[r].desc,new Date(Number(e.ItemModule[r].createTime)*1e3).toLocaleDateString(),Number(e.ItemModule[r].video.height),Number(e.ItemModule[r].video.width),Number(e.ItemModule[r].video.duration),e.ItemModule[r].video.ratio,e.ItemModule[r].stats.shareCount,e.ItemModule[r].stats.diggCount,e.ItemModule[r].stats.commentCount,e.ItemModule[r].stats.playCount,e.ItemModule[r].video.downloadAddr.trim(),e.ItemModule[r].video.cover,e.ItemModule[r].video.dynamicCover,e.ItemModule[r].video.playAddr.trim(),e.ItemModule[r].video.format))}),t}async getMusic(o){if(!o)throw new Error("You must provide a link!");let n=(await this.requestWebsite(o))("#SIGI_STATE").text(),e=JSON.parse(n),t=e.ItemList.video.list[0];return new f(e.ItemModule[t].music.id,e.ItemModule[t].music.title,e.ItemModule[t].music.playUrl,e.ItemModule[t].music.coverLarge,e.ItemModule[t].music.coverThumb,e.ItemModule[t].music.authorName,Number(e.ItemModule[t].music.duration),e.ItemModule[t].music.original,e.ItemModule[t].music.album)}async downloadAllVideosFromUser(o,i){if(!o)throw new Error("Please enter a username!");let n=await this.getAllVideosFromUser(o);if(!n)throw new Error("No Videos were found for this username. Either the videos are private or the user has not videos");if(!i.path){if(i.path=`${d}/../${o}`,T(i.path)){console.log("A folder with this username exists, that is unusual!");try{_(i.path)}catch(e){console.log(`[ERROR] Could not remove ${i.path}
 Error Message: ${e.message}`),q(1)}}T(i.path)||W(i.path)}if(!i.watermark){for(let[e,t]of n.entries()){console.log(`Downloading Video: ${t.description?t.description:t.id}, [${e+1}/${n.length}]`);let u=await this.noWaterMark(t.id);if(!u){console.log(`Could not fetch ${t.description?t.description:t.id} with no watermark`);continue}C(u).pipe(y(`${i.path}/${t.id}_${t.resolution}.${t.format}`))}return}for(let[e,t]of n.entries())console.log(`Downloading Video: ${t.description?t.description:t.id}, [${e+1}/${n.length}]`),C(t.downloadURL).pipe(y(`${i.path}/${t.id}_${t.resolution}.${t.format}`))}async noWaterMark(o){let i="";o.startsWith("https")?i=(await this.video(o)).id:i=o;let e=await(await x("https://api2.musical.ly/aweme/v1/aweme/detail/?aweme_id="+i)).json();if(!e)throw new Error("There was an Error retrieveing this video without watermark!");let t=e.aweme_detail.video.download_addr.uri;if(!t)throw new Error("There was an Error retrieveing this video without watermark!");return`https://api-h2.tiktokv.com/aweme/v1/play/?video_id=${t}`}async hashTag(o){if(!o)throw new Error("You must provide a tag name to complete the search!");let n=(await this.requestWebsite(`https://www.tiktok.com/tag/${o}`))("#SIGI_STATE").text(),e=JSON.parse(n),{ItemList:t}=e,u=[];for(let r of t.challenge.list)u.push(new g(e.ItemModule[r].video.id,e.ItemModule[r].desc,new Date(Number(e.ItemModule[r].createTime)*1e3).toLocaleDateString(),Number(e.ItemModule[r].video.height),Number(e.ItemModule[r].video.width),Number(e.ItemModule[r].video.duration),e.ItemModule[r].video.ratio,e.ItemModule[r].stats.shareCount,e.ItemModule[r].stats.diggCount,e.ItemModule[r].stats.commentCount,e.ItemModule[r].stats.playCount,e.ItemModule[r].video.downloadAddr.trim(),e.ItemModule[r].video.cover,e.ItemModule[r].video.dynamicCover,e.ItemModule[r].video.playAddr.trim(),e.ItemModule[r].video.format,e.ItemModule[r].author));return u}};a(l,"TTScraper");async function Ae(s){if(!s)throw new Error("You must provide a Tiktok video url!");return await new l().video(s)}a(Ae,"fetchVideo");async function Ce(s){if(!s)throw new Error("You must provide a username!");return await new l().user(s)}a(Ce,"fetchUser");async function xe(s){if(!s)throw new Error("You must provide a username!");return await new l().getAllVideosFromUser(s)}a(xe,"fetchAllVideosFromUser");async function ye(s){if(!s)throw new Error("You must provide a Tiktok video url!");return await new l().getMusic(s)}a(ye,"fetchMusic");async function Te(s){if(!s)throw new Error("You must provide a Tiktok video url!");return await new l().noWaterMark(s)}a(Te,"fetchVideoNoWaterMark");async function Ue(s){if(!s)throw new Error("You must provide a tiktok hashtag");return await new l().hashTag(s)}a(Ue,"hashtag");export{f as Music,l as TTScraper,A as TikTokResult,I as User,g as Video,xe as fetchAllVideosFromUser,ye as fetchMusic,Ce as fetchUser,Ae as fetchVideo,Te as fetchVideoNoWaterMark,Ue as hashtag};
